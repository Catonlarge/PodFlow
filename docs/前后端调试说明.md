# 前后端调试说明

> 本文档说明如何启动前后端服务，并在浏览器中查看 AudioPlayer 组件的实际效果。

---

## 📋 前置条件

### 1. 环境要求

- **Python 3.8+**（后端）
- **Node.js 18+**（前端）
- **FFmpeg**（用于音频处理，如果后端需要）
- **后端虚拟环境已创建并安装依赖**

### 2. 数据库初始化

**重要**：如果数据库结构不匹配（如缺少 `transcription_status` 列），需要重新初始化数据库。

#### 方法一：删除旧数据库（推荐，开发环境）

```powershell
# 在项目根目录执行
Remove-Item backend\data\podflow.db -ErrorAction SilentlyContinue
```

#### 方法二：手动删除

直接删除 `backend/data/podflow.db` 文件。

**注意**：删除数据库文件会丢失所有现有数据（Episodes、Podcasts 等）。如果是开发环境，这是可以接受的。

---

## 🚀 启动步骤

### 方法一：使用一键启动脚本（推荐）

在项目根目录执行：

```powershell
.\start-dev.ps1
```

脚本会自动：
- ✅ 检查后端虚拟环境是否存在
- ✅ 检查前端依赖是否安装（如未安装会自动安装）
- ✅ 检查端口是否被占用
- ✅ 启动后端服务（新窗口）
- ✅ 启动前端服务（新窗口）

**使用提示**：
- 两个服务会在独立的 PowerShell 窗口中运行
- 关闭对应窗口即可停止对应服务
- 脚本启动后会自动退出，服务会继续运行

**如果脚本执行失败**：
- 检查是否以管理员权限运行（通常不需要）
- 检查 PowerShell 执行策略：`Get-ExecutionPolicy`
- 如果显示"无法加载"，运行：`Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser`

---

### 方法二：手动启动（分步执行）

#### 步骤 1：启动后端服务

1. **打开第一个终端窗口**（PowerShell 或 CMD）

2. **进入后端目录并激活虚拟环境**：

```powershell
cd backend
.\venv\Scripts\Activate.ps1
```

3. **启动 FastAPI 服务**：

```powershell
python -m uvicorn app.main:app --reload --host 127.0.0.1 --port 8000
```

4. **验证后端启动成功**：

   - 看到以下日志表示启动成功：
     ```
     [System] 数据库初始化完成
     [System] 音频存储目录已创建: D:\...\backend\data\audios
     [System] 静态文件服务路径: D:\...\backend\data\audios
     INFO:     Uvicorn running on http://127.0.0.1:8000
     ```
   
   - 在浏览器访问 `http://localhost:8000/`，应该看到：
     ```json
     {
       "message": "PodFlow 后端连接成功！Whisper 引擎就绪。",
       "status": "running"
     }
     ```

5. **验证静态文件服务**：

   - 访问 `http://localhost:8000/static/audio/` 应该能看到音频文件列表（如果有文件）
   - 或者直接访问一个音频文件：`http://localhost:8000/static/audio/1d19be0e36c5d1247bfb4fe41277aa75.mp3`
   - 如果文件存在，浏览器应该能直接播放或下载

### 步骤 2：启动前端服务

1. **打开第二个终端窗口**（PowerShell 或 CMD）

2. **进入前端目录**：

```powershell
cd frontend
```

3. **安装依赖**（如果还没安装）：

```powershell
npm install
```

4. **启动开发服务器**：

```powershell
npm run dev
```

5. **验证前端启动成功**：

   - 看到以下输出表示启动成功：
     ```
     VITE v7.x.x  ready in xxx ms

     ➜  Local:   http://localhost:5173/
     ➜  Network: use --host to expose
     ```
   
   - 前端服务通常运行在 `http://localhost:5173`（Vite 默认端口）

### 步骤 3：在浏览器中查看效果

1. **打开浏览器**，访问 `http://localhost:5173`

2. **页面内容**：

   页面应该显示两个区域：
   
   - **开发环境检测区域**：
     - 显示 "PodFlow 开发环境检测"
     - 有一个"点击测试连接"按钮
     - 点击后应该显示后端连接成功的消息
   
   - **AudioPlayer 组件测试区域**：
     - 显示 "AudioPlayer 组件测试"
     - 包含一个完整的音频播放器组件
     - 包含播放/暂停按钮、进度条、时间显示、音量控制

3. **测试 AudioPlayer 功能**：

   - **播放/暂停**：点击播放按钮，音频应该开始播放
   - **进度条**：拖动进度条，音频应该跳转到对应位置
   - **时间显示**：播放时，时间应该实时更新（格式：`mm:ss / mm:ss`）
   - **音量控制**：
     - 点击音量按钮可以切换静音/取消静音
     - 拖动音量滑块可以调整音量

---

## 🔍 调试技巧

### 1. 检查浏览器控制台

打开浏览器开发者工具（F12），查看 Console 标签：

- **正常情况**：应该看到 `[AudioPlayer]` 开头的日志，如：
  ```
  [AudioPlayer] 音频元数据加载完成，时长: 330
  [AudioPlayer] 开始播放
  ```

- **错误情况**：如果看到红色错误信息，如：
  ```
  [AudioPlayer] 音频加载错误: ...
  [AudioPlayer] 错误详情: 不支持的音频格式或源文件不存在
  ```
  
  说明音频文件无法访问，检查：
  1. 后端服务是否正常运行
  2. 音频文件是否存在（`backend/data/audios/` 目录）
  3. 静态文件服务路径是否正确

### 2. 检查网络请求

在开发者工具的 Network 标签中：

- **查找音频文件请求**：
  - 请求 URL：`http://localhost:8000/static/audio/xxx.mp3`
  - 状态码应该是 `200`（成功）
  - 如果显示 `404`，说明文件不存在或路径错误

- **检查 CORS 错误**：
  - 如果看到 CORS 相关错误，检查后端 CORS 配置
  - 后端已配置允许所有来源（开发模式），应该不会有 CORS 问题

### 3. 直接访问音频文件

在浏览器中直接访问音频文件 URL：

```
http://localhost:8000/static/audio/1d19be0e36c5d1247bfb4fe41277aa75.mp3
```

- **如果可以直接播放或下载**：说明静态文件服务正常
- **如果显示 404**：检查：
  1. 文件是否存在于 `backend/data/audios/` 目录
  2. 后端启动日志中的静态文件服务路径是否正确

### 4. 检查后端日志

查看后端终端窗口的日志：

- **启动日志**：
  ```
  [System] 数据库初始化完成
  [System] 音频存储目录已创建: ...
  [System] 静态文件服务路径: ...
  ```

- **请求日志**：
  ```
  INFO:     127.0.0.1:xxxxx - "GET /static/audio/xxx.mp3 HTTP/1.1" 200 OK
  ```

- **错误日志**：
  - 如果看到数据库结构不匹配的错误，需要删除数据库文件重新初始化

---

## ❌ 常见问题

### 问题 1：音频无法播放，控制台显示"不支持的音频格式或源文件不存在"

**原因**：
- 后端服务未启动
- 音频文件不存在
- 静态文件服务路径配置错误

**解决方案**：
1. 确认后端服务正在运行（访问 `http://localhost:8000/` 验证）
2. 检查 `backend/data/audios/` 目录是否有音频文件
3. 查看后端启动日志中的静态文件服务路径是否正确
4. 在浏览器中直接访问音频文件 URL，验证是否可以访问

### 问题 2：后端启动失败，显示"no such column: episodes.transcription_status"

**原因**：数据库结构不匹配，缺少新添加的列。

**解决方案**：
1. 删除旧数据库文件：`Remove-Item backend\data\podflow.db`
2. 重新启动后端服务，系统会自动创建新的数据库结构

### 问题 3：前端无法连接后端

**原因**：
- 后端服务未启动
- 端口被占用
- 防火墙阻止

**解决方案**：
1. 确认后端服务正在运行（访问 `http://localhost:8000/`）
2. 检查端口 8000 是否被其他程序占用
3. 查看后端终端是否有错误信息

### 问题 4：前端页面空白或无法加载

**原因**：
- 前端服务未启动
- 端口被占用
- 构建错误

**解决方案**：
1. 确认前端服务正在运行（查看终端输出）
2. 检查端口 5173 是否被占用
3. 查看前端终端是否有错误信息
4. 尝试清除浏览器缓存并刷新页面

### 问题 5：点击播放按钮没有反应

**原因**：
- 音频文件无法加载
- 浏览器自动播放策略限制
- JavaScript 错误

**解决方案**：
1. 打开浏览器控制台，查看是否有错误信息
2. 检查音频文件是否可以访问（直接访问 URL）
3. 某些浏览器需要用户交互后才能播放音频（这是浏览器安全策略）

---

## 📝 测试音频文件

### 使用现有音频文件

后端 `backend/data/audios/` 目录下已有一些测试音频文件，可以在 `App.jsx` 中使用：

```javascript
// 在 frontend/src/App.jsx 中
const testAudioUrl = 'http://localhost:8000/static/audio/1d19be0e36c5d1247bfb4fe41277aa75.mp3';
```

### 上传新音频文件

如果需要测试其他音频文件，可以通过后端 API 上传：

```powershell
# 使用 curl 或 Postman 上传文件
# POST http://localhost:8000/api/episodes/upload
# Form Data:
#   - file: (选择音频文件)
#   - title: "测试音频"
```

上传后，文件会保存到 `backend/data/audios/` 目录，文件名使用 MD5 hash。

---

## 🎯 快速验证清单

启动服务后，按以下清单验证：

- [ ] 后端服务启动成功（访问 `http://localhost:8000/` 有响应）
- [ ] 前端服务启动成功（访问 `http://localhost:5173` 有页面）
- [ ] 开发环境检测按钮可以正常连接后端
- [ ] AudioPlayer 组件正常渲染（显示播放按钮、进度条等）
- [ ] 点击播放按钮，音频可以播放（或显示错误提示）
- [ ] 进度条可以拖动（如果音频已加载）
- [ ] 时间显示正常更新
- [ ] 音量控制正常工作
- [ ] 浏览器控制台没有红色错误信息

---

## 📚 相关文档

- [开发计划.md](./开发计划.md) - 完整的开发计划
- [技术栈.md](./技术栈.md) - 技术栈说明
- [开发配置文档说明.md](./开发配置文档说明.md) - 开发环境配置

---

## 💡 提示

1. **保持两个终端窗口打开**：一个运行后端，一个运行前端
2. **使用浏览器开发者工具**：F12 打开，查看 Console 和 Network 标签
3. **查看终端日志**：前后端的终端窗口都会显示有用的日志信息
4. **热重载**：修改代码后，前后端都会自动重载（如果启用了 `--reload`）

---

**最后更新**：2025-12-25

