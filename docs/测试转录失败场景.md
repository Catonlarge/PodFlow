# 如何测试转录失败效果

## 最简单的方法

### 步骤 1：运行测试脚本

打开 PowerShell，在项目根目录运行：

```powershell
.\test-transcription-fail.ps1 -EpisodeId 1
```

**注意**：参数名和值之间要用**空格**，不能用等号！
- ✅ 正确：`-EpisodeId 1`
- ❌ 错误：`-EpisodeId=1`

把 `1` 改成你要测试的 Episode ID（比如上传音频后看到的 ID）

### 步骤 2：看效果

1. 去前端页面，打开那个 Episode
2. 你会看到：
   - 一行错误提示（比如"模型处理失败，请重试"）
   - 一个蓝色的"请重试"按钮

### 步骤 3：点击重试

点击"请重试"按钮，会重新开始转录。

---

## 测试不同的错误类型

运行脚本时可以指定错误类型：

```powershell
# 网络错误 → 显示"网络问题，请检查网络连接后重试"
.\test-transcription-fail.ps1 -EpisodeId 1 -ErrorType network

# 模型错误 → 显示"模型处理失败，请重试"（默认）
.\test-transcription-fail.ps1 -EpisodeId 1 -ErrorType model

# 文件错误 → 显示"音频处理失败，请重试"
.\test-transcription-fail.ps1 -EpisodeId 1 -ErrorType file

# 内存错误 → 显示"内存不足，请稍后重试"
.\test-transcription-fail.ps1 -EpisodeId 1 -ErrorType memory
```

---

## 其他方法（不推荐，比较复杂）

### 方法 2：浏览器控制台

1. 打开浏览器，按 F12 打开开发者工具
2. 切换到"控制台"标签
3. 粘贴下面代码，回车（把 `1` 改成 Episode ID）：

```javascript
fetch('http://localhost:8000/api/episodes/1/transcribe/test-fail', {
  method: 'POST'
}).then(r => r.json()).then(console.log);
```

---

## 如何验证重试逻辑是否生效

### 方法 1：使用测试脚本（推荐）

运行专门的测试脚本来验证重试逻辑：

```powershell
.\test-retry-logic.ps1 -EpisodeId 4
```

这个脚本会：
1. 自动设置 Episode 为失败状态
2. 调用重试 API（模拟点击"请重试"按钮）
3. 监控状态变化
4. 告诉你重试逻辑是否正常工作

### 方法 2：手动检查状态

运行脚本后，用另一个脚本检查 Episode 状态：

```powershell
# 检查当前状态
.\check-episode-status.ps1 -EpisodeId 4
```

**验证步骤**：
1. 设置失败：`.\test-transcription-fail.ps1 -EpisodeId 4`
2. 检查状态：`.\check-episode-status.ps1 -EpisodeId 4` → 应该显示 `failed`
3. 在前端点击"请重试"按钮
4. 等待 2-3 秒
5. 再次检查状态：`.\check-episode-status.ps1 -EpisodeId 4` → 应该显示 `processing`

### 方法 3：查看后端日志

在运行后端的终端窗口查看日志：
- 如果看到 `[API] 已启动 Episode X 的转录任务` → 重试成功
- 如果看到错误信息 → 可能有问题

### 方法 4：前端观察

1. 设置失败状态后，前端应该显示错误提示和"请重试"按钮
2. 点击"请重试"按钮
3. 观察：
   - 按钮点击后，错误提示应该消失
   - 应该显示"请稍等，努力识别字幕中..."的进度条
   - 说明重试逻辑生效了

---

## 注意事项

- 测试前确保后端服务在运行
- 测试完成后，点击"请重试"按钮就能恢复正常
- 这个只是用来测试，不会真的去转录

